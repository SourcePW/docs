- # nftables

# 入门
nftables 框架提供了数据包分类功能。最显著的功能是：

- 内置查找`表`而不是线性处理
- `IPv4` 和 `IPv6` 使用同一个协议框架
- 规则会以一个整体被应用，而不是分为`抓取`、`更新`和`存储`完整的规则集的步骤
- 支持在规则集(`nfstrace`)和监控追踪事件（nft）中调试和追踪
- 更加一致和压缩的语法，没有特定协议的扩展
- 用于第三方应用程序的 `Netlink API`


`nftables` 框架使用`表`来存储`链`。`链`包含执行动作的独立`规则`。`libnftnl` 库可用于通过 `libmnl` 库与 `nftables Netlink API` 进行低级交互。  

要显示规则集变化的影响，请使用 `nft list ruleset` 命令。由于这些工具将表、链、规则、集合和其他对象添加到 `nftables` 规则集中，请注意， `nftables`规则集操作（如 `nft flush ruleset` 命令）可能会影响使用之前独立的旧命令安装的规则集。  


## 从 iptables 迁移到 nftables  

### 将 `iptables` 和 `ip6tables` 规则集转换为 `nftables` 
1. 将 `iptables` 和 `ip6tables` 规则写入一个文件： 

```shell
$ iptables-save >/root/iptables.dump
$ ip6tables-save >/root/ip6tables.dump
```

2. 将转储文件转换为 `nftables` 指令

```shell
$ iptables-restore-translate -f /root/iptables.dump > /etc/nftables/ruleset-migrated-from-iptables.nft
$ ip6tables-restore-translate -f /root/ip6tables.dump > /etc/nftables/ruleset-migrated-from-ip6tables.nft
```

3. 检查，如果需要，手动更新生成的 `nftables` 规则  

4. 要启用 nftables 服务来加载生成的文件，请在 `/etc/sysconfig/nftables.conf` 文件中添加以下内容：  

```shell
include "/etc/nftables/ruleset-migrated-from-iptables.nft"
include "/etc/nftables/ruleset-migrated-from-ip6tables.nft"
```

5. 停止并禁用 `iptables` 服务：

```shell
$ systemctl disable --now iptables
```

如果您使用自定义脚本加载 iptables 规则，请确保脚本不再自动启动并重新引导以刷新所有表。  

6. 启用并启动 `nftables` 服务  

```shell
$ systemctl enable --now nftables
```

7. 查看

```shell
$ nft list ruleset
```

示例程序:
```shell
# 清空
iptables -F

# 设置规则
iptables -A INPUT -i enp1s0 -p tcp -s 192.168.10.0/24 -d 192.168.10.0/24 -m mac --mac-source 90:b8:e0:01:4b:05 -j LOG -m time --timestart 09:00 --timestop 18:00 --weekdays Mon,Tue,Wed 

iptables -A INPUT -p tcp --dport 80 -j ACCEPT

iptables -A OUTPUT -p tcp --sport 80 -j ACCEPT

# 查看规则
iptables -L -n

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
LOG        tcp  --  192.168.10.0/24      192.168.10.0/24      MAC 90:B8:E0:01:4B:05 TIME from 09:00:00 to 18:00:00 on Mon,Tue,Wed UTC LOG flags 0 level 4
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:80


```

存储规则
`iptables-save >/root/iptables-bak.dump`  

```shell
# Generated by iptables-save v1.8.4 on Wed Oct 12 16:14:49 2022
*filter
:INPUT ACCEPT [507:39091]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [494:42873]
-A INPUT -s 192.168.10.0/24 -d 192.168.10.0/24 -i enp1s0 -p tcp -m mac --mac-source 90:B8:E0:01:4B:05 -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays Mon,Tue,Wed --datestop 2038-01-19T03:14:07 -j LOG
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 80 -j ACCEPT
COMMIT
# Completed on Wed Oct 12 16:14:49 2022
```

转换
`iptables-restore-translate -f /root/iptables-bak.dump > /root/ruleset-migrated-from-iptables.nft`  

```shell
add table ip filter
add chain ip filter INPUT { type filter hook input priority 0; policy accept; }
add chain ip filter FORWARD { type filter hook forward priority 0; policy accept; }
add chain ip filter OUTPUT { type filter hook output priority 0; policy accept; }
# -t filter -A INPUT -s 192.168.10.0/24 -d 192.168.10.0/24 -i enp1s0 -p tcp -m mac --mac-source 90:B8:E0:01:4B:05 -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays Mon,Tue,Wed --datestop 2038-01-19T03:14:07 -j LOG 
add rule ip filter INPUT tcp dport 80 counter accept
add rule ip filter OUTPUT tcp sport 80 counter accept
# Completed on Wed Oct 12 08:17:01 2022
```

修改后
```shell
nft add table ip filter
nft add chain ip filter INPUT '{ type filter hook input priority 0; policy accept; }'
nft add chain ip filter FORWARD '{ type filter hook forward priority 0; policy accept; }'
nft add chain ip filter OUTPUT '{ type filter hook output priority 0; policy accept; }'
nft add rule ip filter INPUT tcp dport 80 counter accept
nft add rule ip filter OUTPUT tcp sport 80 counter accept
```

转换后的格式`nft list ruleset`
```shell
table ip filter {
	chain INPUT {
		type filter hook input priority filter; policy accept;
		tcp dport 80 counter packets 0 bytes 0 accept
	}

	chain FORWARD {
		type filter hook forward priority filter; policy accept;
	}

	chain OUTPUT {
		type filter hook output priority filter; policy accept;
		tcp sport 80 counter packets 0 bytes 0 accept
	}
}
```

转换不准确呀，如果有元素，可以设置为`set`  

```shell
set dest_addrs {
                type ipv4_addr
                flags interval
                elements = { 10.1.0.0-10.3.255.255, 10.10.0.0/16,
                             192.168.0.0/16 }
        }

chain POSTROUTING {
                type nat hook postrouting priority 0; policy accept;
                oifname "eth0" counter packets 10674 bytes 669286 log ip saddr @user_vips ip daddr @dest_addrs masquerade ## handle 14
        }
```


## 调式
创建带有计数器的规则
```shell
nft add table inet example_table
nft add chain inet example_table example_chain
nft add rule inet example_table example_chain tcp dport 22 counter accept
```

也可以在现有规则中增加计数器
```shell
nft --handle list chain inet example_table example_chain

table inet example_table {
  chain example_chain { # handle 1
    type filter hook input priority filter; policy accept;
    tcp dport ssh accept # handle 4
  }
}

# 修改
nft replace rule inet example_table example_chain handle 4 tcp dport 22 counter accept

# 查看
# nft list ruleset
table inet example_table {
  chain example_chain {
    type filter hook input priority filter; policy accept;
    tcp dport ssh counter packets 6872 bytes 105448565 accept
  }
}
```

追踪
```shell
$ nft monitor | grep "inet example_table example_chain"
```



